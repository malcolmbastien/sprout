---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import ProfileHeader from "../../components/Profile/ProfileHeader.astro";
import BackToGarden from "../../components/Navigation/BackToGarden.astro";
import SiteFooter from "../../components/SiteFooter.astro";
import { getStageColors } from "../../lib/theme";

export async function getStaticPaths() {
const allNotes = await getCollection("notes");
    const topics = new Set<string>();
    allNotes.forEach((note) => {
        note.data.tags.forEach((tag) => topics.add(tag));
    });
    return Array.from(topics).map((topic) => ({
        params: { topic },
    }));
}

const { topic } = Astro.params;

const allNotes = await getCollection("notes");
const filteredNotes = allNotes.filter((note) => note.data.tags.includes(topic!));

const stageColors = getStageColors();

const sortedNotes = filteredNotes.sort(
    (a, b) =>
        (b.data.publishedDate?.getTime() || 0) -
        (a.data.publishedDate?.getTime() || 0),
);
---

<Layout
    title={`#${topic} - Notes - Sprout`}
    description={`All notes about #${topic}`}
    type="website"
>
    <main class="max-w-7xl mx-auto p-4 md:p-8" data-pagefind-ignore>
        <ProfileHeader />
        <!-- Back to Home Link -->
        <BackToGarden class="-mt-2 mb-8" />

        <div class="mb-6">
            <h1
                class="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight mb-2"
            >
                #{topic}
            </h1>
            <p class="text-slate-600 dark:text-slate-400">
                {sortedNotes.length} note{sortedNotes.length !== 1 ? "s" : ""} found
            </p>
        </div>

        {
            sortedNotes.length === 0 ? (
                <div class="bg-white dark:bg-[#121812] border border-slate-200 dark:border-slate-800 rounded-xl p-8 text-center">
                    <p class="text-slate-600 dark:text-slate-400">
                        No notes found for this topic.
                    </p>
                </div>
            ) : (
                <div class="space-y-4">
                    {sortedNotes.map((note) => (
                        <a
                            href={`/notes/${note.id}`}
                            class="block bg-white dark:bg-[#121812] border border-slate-200 dark:border-slate-800 rounded-xl p-5 hover:border-emerald-500 dark:hover:border-emerald-500 transition-colors group"
                        >
                            <div class="flex items-center gap-2 mb-2">
                                <span
                                    class={`px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${stageColors[note.data.stage as keyof typeof stageColors]}`}
                                >
                                    {
                                        note.data.stage === "seed"
                                            ? "ðŸŒ±"
                                            : note.data.stage === "sprout"
                                              ? "ðŸŒ¿"
                                              : "ðŸŒ²"
                                    }{" "}
                                    {note.data.stage}
                                </span>
                                {note.data.publishedDate && (
                                    <time class="text-sm text-slate-500 dark:text-slate-400">
                                        {note.data.publishedDate.toLocaleDateString(
                                            "en-US",
                                            {
                                                year: "numeric",
                                                month: "short",
                                                day: "numeric",
                                            },
                                        )}
                                    </time>
                                )}
                            </div>
                            <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2 group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors">
                                {note.data.title}
                            </h2>
                            {note.data.summary && (
                                <p class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2">
                                    {note.data.summary}
                                </p>
                            )}
                        </a>
                    ))}
                </div>
            )
        }
        <SiteFooter />
    </main>
</Layout>
