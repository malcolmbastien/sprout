---
import { getPostsCommits } from "../../lib/git-history";

const commits = await getPostsCommits();
const commitDates = commits.map(
    (c) => new Date(c.date).toISOString().split("T")[0],
);

// Count commits per day
const activityMap: Record<string, number> = {};
commitDates.forEach((date) => {
    activityMap[date] = (activityMap[date] || 0) + 1;
});

interface DayData {
    date: string;
    count: number;
}

interface MonthLabel {
    name: string;
    weekIndex: number;
}

// Generate last ~53 weeks (371 days) to ensure current week is fully included
const numDays = 371;
const today = new Date();
const days: DayData[] = [];
for (let i = numDays - 1; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().split("T")[0];
    days.push({
        date: dateStr,
        count: activityMap[dateStr] || 0,
    });
}
// days[0] is ~53 weeks ago, days[370] is today

// Generate month labels
const monthLabels: MonthLabel[] = [];
let lastMonth = "";
for (let i = days.length - 1; i >= 0; i--) {
    // Start from newest day
    const d = new Date(days[i].date);
    const monthKey = d.toLocaleDateString("en-US", { month: "short" });
    if (monthKey !== lastMonth) {
        const weekIndex = Math.floor(i / 7);
        // Skip if too close to the end to avoid overlap
        if (weekIndex < 50) {
            monthLabels.push({
                name: monthKey,
                weekIndex: weekIndex,
            });
        }
        lastMonth = monthKey;
    }
}

function getColor(count: number) {
    if (count === 0) return "fill-slate-100 dark:fill-[#1a241a]";
    if (count === 1) return "fill-emerald-200 dark:fill-emerald-900/40";
    if (count === 2) return "fill-emerald-400 dark:fill-emerald-700";
    if (count >= 3) return "fill-emerald-600 dark:fill-emerald-500";
    return "fill-slate-100 dark:fill-[#1a241a]";
}
---

<div
    class="bg-white dark:bg-[#121812] border border-slate-200 dark:border-slate-800 rounded-xl p-4 mb-2"
>
    <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100 mb-4">
        Activity
    </h3>
    <div class="overflow-x-hidden">
        <svg
            width="742"
            height="100"
            class="mx-auto sm:left-0 left-100 relative"
        >
            {
                monthLabels.map((label) => (
                    <text
                        x={label.weekIndex * 14 + 7}
                        y="8"
                        text-anchor="middle"
                        class="fill-slate-500 dark:fill-slate-400 text-[10px] font-medium"
                    >
                        {label.name}
                    </text>
                ))
            }
            {
                Array.from({ length: 53 }).map((_, weekIndex) => (
                    <g transform={`translate(${weekIndex * 14}, 15)`}>
                        {Array.from({ length: 7 }).map((_, dayIndex) => {
                            const dayData = days[weekIndex * 7 + dayIndex];
                            if (!dayData) return null;
                            const dayOfWeek = new Date(dayData.date).getDay(); // 0=Sunday, 6=Saturday
                            return (
                                <rect
                                    x="0"
                                    y={dayOfWeek * 12}
                                    width="11"
                                    height="11"
                                    rx="2"
                                    class={`${getColor(dayData.count)} transition-colors duration-300 hover:stroke-slate-400 dark:hover:stroke-slate-500 hover:stroke-1 ${dayData.count > 0 ? "cursor-pointer" : ""}`}
                                    data-date={dayData.date}
                                    data-count={dayData.count}
                                    onclick={
                                        dayData.count > 0
                                            ? `filterByDate('${dayData.date}')`
                                            : undefined
                                    }
                                />
                            );
                        })}
                    </g>
                ))
            }
        </svg>
    </div>
    <div
        class="mt-4 flex items-center justify-end gap-2 text-[10px] text-slate-400 uppercase tracking-widest"
    >
        <span>Less</span>
        <div class="w-3 h-3 bg-slate-100 dark:bg-[#1a241a] rounded-xs"></div>
        <div class="w-3 h-3 bg-emerald-200 dark:bg-emerald-900/40 rounded-xs">
        </div>
        <div class="w-3 h-3 bg-emerald-400 dark:bg-emerald-700 rounded-xs">
        </div>
        <div class="w-3 h-3 bg-emerald-600 dark:bg-emerald-500 rounded-xs">
        </div>
        <span>More</span>
    </div>

    <script>
        // Store the currently selected date
        let selectedDate: string | null = null;

        // Function to filter posts by date
        (window as any).filterByDate = function (dateString: string) {
            // If clicking the same date, clear the filter
            if (selectedDate === dateString) {
                selectedDate = null;
                // Clear any existing date filters
                const event = new CustomEvent("dateFilterChange", {
                    detail: { date: null },
                });
                window.dispatchEvent(event);
                // Reset visual feedback
                document
                    .querySelectorAll(".activity-day.selected")
                    .forEach((el) => {
                        el.classList.remove("selected");
                    });
                return;
            }

            selectedDate = dateString;

            // Dispatch custom event to notify the main filtering system
            const event = new CustomEvent("dateFilterChange", {
                detail: { date: dateString },
            });
            window.dispatchEvent(event);

            // Add visual feedback to selected day
            document
                .querySelectorAll(".activity-day.selected")
                .forEach((el) => {
                    el.classList.remove("selected");
                });

            // Find and highlight the clicked day
            const clickedDay = document.querySelector(
                `[data-date="${dateString}"]`,
            );
            if (clickedDay) {
                clickedDay.classList.add("selected");
            }
        };

        // Add selected class styling
        const style = document.createElement("style");
        style.textContent = `
			.activity-day.selected {
				stroke: #2563eb !important;
				stroke-width: 2px !important;
			}
			.dark .activity-day.selected {
				stroke: #3b82f6 !important;
			}
		`;
        document.head.appendChild(style);

        // Add selected class to all activity days for styling
        document.querySelectorAll("[data-date]").forEach((el) => {
            el.classList.add("activity-day");
        });
    </script>
</div>
