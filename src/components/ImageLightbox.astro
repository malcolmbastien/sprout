---
---

<div
    id="lightbox"
    class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 opacity-0 pointer-events-none transition-opacity duration-300 cursor-zoom-out"
    aria-hidden="true"
>
    <div class="relative w-full h-full flex items-center justify-center p-4 md:p-8">
        <img
            id="lightbox-img"
            src=""
            alt=""
            class="max-w-full max-h-[85vh] object-contain shadow-2xl transition-all duration-300 scale-95 cursor-zoom-out"
        />
        
        <div 
            id="lightbox-caption" 
            class="absolute bottom-12 left-1/2 -translate-x-1/2 text-white/90 text-center px-6 py-3 bg-black/60 backdrop-blur-md max-w-[90%] md:max-w-2xl rounded-2xl text-sm md:text-base opacity-0 transition-all duration-300 translate-y-4 border border-white/10"
        ></div>
        
        <button
            id="lightbox-prev"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all p-2 md:p-4 hover:scale-110 opacity-0 pointer-events-none"
            aria-label="Previous image"
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-12 md:w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>

        <button
            id="lightbox-next"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all p-2 md:p-4 hover:scale-110 opacity-0 pointer-events-none"
            aria-label="Next image"
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-12 md:w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>

        <button
            id="lightbox-close"
            class="absolute top-4 right-4 text-white/70 hover:text-white transition-colors p-2"
            aria-label="Close lightbox"
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
</div>

<script>
    interface LightboxImage {
        src: string;
        alt: string;
        caption: string;
    }

    function initLightbox() {
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
        const lightboxCaption = document.getElementById('lightbox-caption');
        const closeBtn = document.getElementById('lightbox-close');
        const prevBtn = document.getElementById('lightbox-prev');
        const nextBtn = document.getElementById('lightbox-next');
        
        if (!lightbox || !lightboxImg || !closeBtn || !prevBtn || !nextBtn) return;

        let allImages: LightboxImage[] = [];
        let currentIndex = 0;

        function updateLightbox(index: number) {
            if (index < 0 || index >= allImages.length) return;
            currentIndex = index;
            const img = allImages[currentIndex];

            // Start fade out
            lightboxImg.classList.add('opacity-0');
            if (lightboxCaption) lightboxCaption.classList.add('opacity-0');

            setTimeout(() => {
                lightboxImg.src = img.src;
                lightboxImg.alt = img.alt;
                
                if (lightboxCaption) {
                    if (img.caption) {
                        lightboxCaption.textContent = img.caption;
                        lightboxCaption.classList.remove('opacity-0', 'translate-y-4');
                        lightboxCaption.classList.add('opacity-100', 'translate-y-0');
                    } else {
                        lightboxCaption.textContent = '';
                        lightboxCaption.classList.remove('opacity-100', 'translate-y-0');
                        lightboxCaption.classList.add('opacity-0', 'translate-y-4');
                    }
                }
                
                lightboxImg.classList.remove('opacity-0');
            }, 150);

            // Show/hide nav buttons
            if (allImages.length > 1) {
                prevBtn?.classList.remove('opacity-0', 'pointer-events-none');
                nextBtn?.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                prevBtn?.classList.add('opacity-0', 'pointer-events-none');
                nextBtn?.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        function openLightbox(index: number) {
            currentIndex = index;
            const img = allImages[currentIndex];
            
            lightboxImg.src = img.src;
            lightboxImg.alt = img.alt;
            
            if (lightboxCaption) {
                if (img.caption) {
                    lightboxCaption.textContent = img.caption;
                    lightboxCaption.classList.remove('opacity-0', 'translate-y-4');
                    lightboxCaption.classList.add('opacity-100', 'translate-y-0');
                } else {
                    lightboxCaption.textContent = '';
                    lightboxCaption.classList.remove('opacity-100', 'translate-y-0');
                    lightboxCaption.classList.add('opacity-0', 'translate-y-4');
                }
            }

            lightbox?.classList.remove('opacity-0', 'pointer-events-none');
            lightbox?.classList.add('opacity-100');
            lightboxImg?.classList.remove('scale-95');
            lightboxImg?.classList.add('scale-100');
            document.body.style.overflow = 'hidden';
            lightbox?.setAttribute('aria-hidden', 'false');

            if (allImages.length > 1) {
                prevBtn?.classList.remove('opacity-0', 'pointer-events-none');
                nextBtn?.classList.remove('opacity-0', 'pointer-events-none');
            }
        }

        function closeLightbox() {
            lightbox?.classList.add('opacity-0', 'pointer-events-none');
            lightbox?.classList.remove('opacity-100');
            lightboxImg?.classList.remove('scale-100');
            lightboxImg?.classList.add('scale-95');
            
            if (lightboxCaption) {
                lightboxCaption.classList.remove('opacity-100', 'translate-y-0');
                lightboxCaption.classList.add('opacity-0', 'translate-y-4');
            }

            prevBtn?.classList.add('opacity-0', 'pointer-events-none');
            nextBtn?.classList.add('opacity-0', 'pointer-events-none');

            document.body.style.overflow = '';
            lightbox?.setAttribute('aria-hidden', 'true');
            
            setTimeout(() => {
                if (lightbox?.classList.contains('opacity-0')) {
                    lightboxImg.src = '';
                    if (lightboxCaption) lightboxCaption.textContent = '';
                }
            }, 300);
        }

        function showNext(e?: Event) {
            e?.stopPropagation();
            const nextIndex = (currentIndex + 1) % allImages.length;
            updateLightbox(nextIndex);
        }

        function showPrev(e?: Event) {
            e?.stopPropagation();
            const prevIndex = (currentIndex - 1 + allImages.length) % allImages.length;
            updateLightbox(prevIndex);
        }

        // Add click listeners to all images in the article content
        const article = document.querySelector('article');
        if (article) {
            const imgElements = Array.from(article.querySelectorAll('img')).filter(img => {
                const imageEl = img as HTMLImageElement;
                return imageEl.width >= 100 || imageEl.height >= 100;
            }) as HTMLImageElement[];

            allImages = imgElements.map(imageEl => {
                let caption = '';
                
                // 1. Check for .gallery-item (from remark-gallery)
                const galleryItem = imageEl.closest('.gallery-item');
                if (galleryItem) {
                    const em = galleryItem.querySelector('em');
                    if (em) caption = em.textContent || '';
                }

                // 2. Check for figcaption if wrapped in figure
                if (!caption) {
                    const figure = imageEl.closest('figure');
                    if (figure) {
                        const figcaption = figure.querySelector('figcaption');
                        if (figcaption) caption = figcaption.textContent || '';
                    }
                }
                
                // 3. Check for em tag in the same paragraph
                if (!caption) {
                    const parentP = imageEl.closest('p');
                    if (parentP) {
                        const em = parentP.querySelector('em');
                        if (em) caption = em.textContent || '';
                    }
                }
                
                // 4. Fallback to alt text
                if (!caption && imageEl.alt && !imageEl.alt.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
                    caption = imageEl.alt;
                }

                return {
                    src: imageEl.src,
                    alt: imageEl.alt,
                    caption: caption.trim()
                };
            });

            imgElements.forEach((img, index) => {
                img.classList.add('cursor-zoom-in');
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openLightbox(index);
                });
            });
        }

        // Close on backdrop click
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox || e.target === lightbox.firstElementChild) {
                closeLightbox();
            }
        });

        closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeLightbox();
        });

        prevBtn.addEventListener('click', showPrev);
        nextBtn.addEventListener('click', showNext);

        // Prevent closing when clicking the image or caption
        lightboxImg.addEventListener('click', (e) => e.stopPropagation());
        lightboxCaption?.addEventListener('click', (e) => e.stopPropagation());

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (lightbox.classList.contains('opacity-0')) return;

            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowRight') showNext();
            if (e.key === 'ArrowLeft') showPrev();
        });
    }

    // Initialize on load
    initLightbox();

    // Re-initialize on Astro navigation
    document.addEventListener('astro:after-swap', initLightbox);
</script>
